{include file="header.html"}
<div class="page-header">
	<h6>
		商品管理
		<small>
			<i class="ace-icon fa fa-angle-double-right"></i>
			{if $row->id>0}编辑{else}添加{/if}商品
		</small>
	</h6>
</div>
<div class="row">
<div class="col-xs-12">
	<form class="form-horizontal" role="form" method="post" action="?app=goods&act=edit" enctype="multipart/form-data">
		<input type="hidden" name="id" value="{$row->id}" />
		{if $edition>2}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="name">商品类型</label>
			<div class="col-sm-10 goods-type-box">
				<label class="goods-type">
					<input type="radio" name="type" value="0" {if $row->type==0}checked{/if} />
					<div>实物商品<span>(物流发货)</span></div>
				</label>
				<label class="goods-type">
					<input type="radio" name="type" value="1" {if $row->type==1}checked{/if} />
					<div>虚拟商品<span>(无需物流)</span></div>
				</label>
				<label class="goods-type">
					<input type="radio" name="type" value="2" {if $row->type==2}checked{/if} />
					<div>电子卡券<span>(无需物流)</span></div>
				</label>
				<label class="goods-type">
					<input type="radio" name="type" value="3" {if $row->type==3}checked{/if} />
					<div>酒店商品<span>(无需物流)</span></div>
				</label>
				<label class="goods-type">
					<input type="radio" name="type" value="4" {if $row->type==4}checked{/if} />
					<div>蛋糕烘焙(外卖)<span>(同城送或自提)</span></div>
				</label>
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="name">商品名称</label>
			<div class="col-sm-10">
				<input type="text" id="name" name="name" value="{$row->name}" class="col-xs-6 coo-need" />
			</div>
		</div>
		{if in_array('category', $function)}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="category_id">分类</label>
			<div class="col-sm-2">
				<select name="category_id" id="category_id" class="form-control some-width180 coo-need">
					<option value="">请选择分类</option>
					{$categories}
				</select>
			</div>
		</div>
		{/if}
		{if in_array('shop', $function)}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="shop_id">店铺</label>
			<div class="col-sm-10">
				<select class="selectpicker" id="shop_id" name="shop_id" search="true">
					<option value="">请选择店铺</option>
					{foreach from=$shop item=g}
					<option value="{$g->id}" {if $g->id==$row->shop_id}selected{/if}>{$g->name}</option>
					{/foreach}
				</select>
			</div>
		</div>
		{/if}
		{if in_array('brand', $function)}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="brand_id">品牌</label>
			<div class="col-sm-2">
				<select name="brand_id" id="brand_id" class="form-control">
					<option value="">请选择品牌</option>
					{foreach from=$brand item=g}
					<option value="{$g->id}" {if $g->id==$row->brand_id}selected{/if}>{$g->name}</option>
					{/foreach}
				</select>
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="pic">主图片</label>
			<div class="col-sm-10">
				<input type="hidden" name="origin_pic" id="origin_pic" value="{$row->pic}" />
				<div class="col-file col-xs-3"><input type="file" id="pic" name="pic" value="" /></div>
				{if $row->pic}<a href="{$row->pic}" target="_blank"><img src="{$row->pic}" height="34" onerror="this.src='/images/nopic.png'" /></a>{/if}
				<span class="some-line">图片比例为 1:1</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="ad_pic">广告图</label>
			<div class="col-sm-10">
				<input type="hidden" name="origin_ad_pic" id="origin_ad_pic" value="{$row->ad_pic}" />
				<div class="col-file col-xs-3"><input type="file" id="ad_pic" name="ad_pic" value="" /></div>
				{if $row->ad_pic}<a href="{$row->ad_pic}" target="_blank"><img src="{$row->ad_pic}" height="34" onerror="this.src='/images/nopic.png'" /></a>{/if}
				<span class="some-line">图片比例为 2:1</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="files">图片相册</label>
			<div class="col-sm-10">
				<div class="col-file col-xs-3" id="file"><input type="file" id="files" /></div>
				<span class="some-line">图片比例为 1:1</span>
				<div id="imgs">
					{if is_array($pics)}
					{foreach from=$pics item=g}
					<div>
						<span title="拖动改变顺序">≡</span>
						<a href="{$g->pic}" target="_blank"></a>
						<input type="hidden" name="pics[]" value="{$g->pic}" />
						<input type="text" name="memos[]" placeholder="图片说明" value="{$g->memo}" />
						<input type="text" name="videos[]" placeholder="视频网址" value="{$g->video}" />
						<a href="javascript:void(0)" onclick="deletePic(this)"></a>
					</div>
					{/foreach}
					{/if}
				</div>
			</div>
		</div>
		{if $edition>1}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="spec">商品规格</label>
			<div class="col-sm-10">
				<div class="mul-group spec-group">
					<div class="mul-group-row spec-row">{if is_array($spec)}
						{foreach from=$spec item=g key=i}
						<div class="mul-list spec-list">
							<div class="form-group">
								<label class="col-sm-1 control-label no-padding-right">规格名</label>
								<div class="col-sm-11">
									<div class="col-xs-2">
										<input type="text" value="{$g->name}" class="spec-field spec-name some-width100p" spec_id="{$g->spec_id}" parent_id="0" />
										<input type="hidden" name="spec_id[]" value="{$g->spec_id}" />
									</div>
									<a href="javascript:void(0)" class="del" parent="spec-list">×</a>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-1 control-label no-padding-right">规格值</label>
								<div class="col-sm-11 {if is_array($g->sub) && count($g->sub)}active{/if}">
									{if is_array($g->sub)}
									{foreach from=$g->sub item=s}
									<div class="col-xs-2">
										<input type="text" value="{$s->name}" class="spec-field spec-subname some-width100p" spec_id="{$s->spec_id}" parent_id="{$s->parent_id}" />
										<input type="hidden" name="spec_subid[]" value="{$s->spec_id}" />
										<a href="javascript:void(0)" class="del" parent="col-xs-2">×</a>
									</div>
									{/foreach}
									{/if}
									<a href="javascript:void(0)" class="add" parent_id="{$g->spec_id}">添加规格值</a>
								</div>
							</div>
						</div>
						{/foreach}
					{/if}</div>
					<div class="mul-toolbar spec-toolbar">
						<button type="button" class="btn btn-info btn-sm" {if is_array($spec) && count($spec)>=3}disabled{/if}>
							<i class="ace-icon fa fa-plus"></i>添加规格项目
						</button>
					</div>
				</div>
				<span class="some-line">如有颜色、尺码等多种规格，请添加商品规格</span>
			</div>
		</div>
		<div class="form-group spec-detail hidden">
			<label class="col-sm-2 control-label no-padding-right" for="spec-detail">规格明细</label>
			<div class="col-sm-10">
				<div class="spec-table"></div>
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="price">价格</label>
			<div class="col-sm-10">
				<input type="text" id="price" name="price" value="{if $row->price>0}{$row->price}{/if}" class="col-xs-2 coo-float->0" />
				<span class="some-block">元</span>
			</div>
		</div>
		{if $edition>2}
		<div class="col-ra">
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="promote_price">促销价</label>
			<div class="col-sm-10">
				<input type="text" id="promote_price" name="promote_price" value="{if $row->promote_price>0}{$row->promote_price}{/if}" class="col-xs-2 coo-!>=0" />
				<span class="some-block">元</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="promote_begin_time">促销时间</label>
			<div class="col-sm-10">
				<input type="text" id="promote_begin_time" name="promote_begin_time" value="{if $row->promote_begin_time>0}{date('Y-m-d H:i', $row->promote_begin_time)}{/if}" class="col-xs-2" />
				<span class="some-item">-</span>
				<input type="text" id="promote_end_time" name="promote_end_time" value="{if $row->promote_end_time>0}{date('Y-m-d H:i', $row->promote_end_time)}{/if}" class="col-xs-2" />
				<span class="some-line">不填即永久促销</span>
			</div>
		</div>
		{if in_array('groupbuy', $function)}
		<div class="ge-group"></div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_price">拼团价</label>
			<div class="col-sm-10">
				<input type="text" name="groupbuy_price" id="groupbuy_price" value="{if $row->groupbuy_price>0}{$row->groupbuy_price}{/if}" class="col-xs-2" />
				<span class="some-block">元</span>
				<span class="some-line">留空即不参与拼团活动</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_begin_time">拼团时间</label>
			<div class="col-sm-10">
				<input type="text" id="groupbuy_begin_time" name="groupbuy_begin_time" value="{if $row->groupbuy_begin_time>0}{date('Y-m-d H:i', $row->groupbuy_begin_time)}{/if}" class="col-xs-2 coo-^#groupbuy_end_time" @="#groupbuy_end_time" />
				<span class="some-item">-</span>
				<input type="text" id="groupbuy_end_time" name="groupbuy_end_time" value="{if $row->groupbuy_end_time>0}{date('Y-m-d H:i', $row->groupbuy_end_time)}{/if}" class="col-xs-2" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_amount">拼团数量</label>
			<div class="col-sm-10">
				<input type="text" name="groupbuy_amount" id="groupbuy_amount" value="{if $row->groupbuy_amount>0}{$row->groupbuy_amount}{/if}" class="col-xs-2 coo-!<=#stocks" />
				<span class="some-line">留空即为最大库存数，不可大于库存数</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_number">成团人数</label>
			<div class="col-sm-10">
				<input type="text" name="groupbuy_number" id="groupbuy_number" value="{if $row->groupbuy_number>0}{$row->groupbuy_number}{/if}" class="col-xs-2 coo-!<=#stocks" />
				<span class="some-block">人</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_time">成团限时</label>
			<div class="col-sm-10">
				<input type="text" name="groupbuy_time" id="groupbuy_time" value="{if $row->groupbuy_time>0}{$row->groupbuy_time}{/if}" class="col-xs-2" />
				<span class="some-block">小时内</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_limit">每人限拼</label>
			<div class="col-sm-10">
				<input type="text" name="groupbuy_limit" id="groupbuy_limit" value="{if $row->groupbuy_limit>0}{$row->groupbuy_limit}{/if}" class="col-xs-2" />
				<span class="some-block">件</span>
				<span class="some-line">留空即不限制</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="groupbuy_free_shipping">拼团时包邮</label>
			<div class="col-sm-10">
				<div class="radio">
					<label>
						<input type="radio" name="groupbuy_free_shipping" value="0" class="ace" {if $row->groupbuy_free_shipping==0}checked{/if} />
						<span class="lbl">否</span>
					</label>
				</div>
				<div class="radio">
					<label>
						<input type="radio" name="groupbuy_free_shipping" value="1" class="ace" {if $row->groupbuy_free_shipping==1}checked{/if} />
						<span class="lbl">是</span>
					</label>
				</div>
			</div>
		</div>
		{/if}
		{if in_array('purchase', $function)}
		<div class="ge-group"></div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_price">秒杀价</label>
			<div class="col-sm-10">
				<input type="text" name="purchase_price" id="purchase_price" value="{if $row->purchase_price>0}{$row->purchase_price}{/if}" class="col-xs-2" />
				<span class="some-block">元</span>
				<span class="some-line">留空即不参与秒杀活动</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_begin_time">秒杀时间</label>
			<div class="col-sm-10">
				<input type="text" id="purchase_begin_time" name="purchase_begin_time" value="{if $row->purchase_begin_time>0}{date('Y-m-d H:i', $row->purchase_begin_time)}{/if}" class="col-xs-2 coo-^#purchase_end_time" @="#purchase_end_time" />
				<span class="some-item">-</span>
				<input type="text" id="purchase_end_time" name="purchase_end_time" value="{if $row->purchase_end_time>0}{date('Y-m-d H:i', $row->purchase_end_time)}{/if}" class="col-xs-2" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_amount">秒杀数量</label>
			<div class="col-sm-10">
				<input type="text" name="purchase_amount" id="purchase_amount" value="{if $row->purchase_amount>0}{$row->purchase_amount}{/if}" class="col-xs-2 coo-!<=#stocks" />
				<span class="some-line">留空即为最大库存数，不可大于库存数</span>
			</div>
		</div>
		{if $row->purchase_count>0}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_count">已秒杀</label>
			<div class="col-sm-10">
				<h5>{$row->purchase_count}件</h5>
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_limit">每人限秒</label>
			<div class="col-sm-10">
				<input type="text" name="purchase_limit" id="purchase_limit" value="{if $row->purchase_limit>0}{$row->purchase_limit}{/if}" class="col-xs-2" />
				<span class="some-block">件</span>
				<span class="some-line">留空即不限制</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="purchase_free_shipping">秒杀时包邮</label>
			<div class="col-sm-10">
				<div class="radio">
					<label>
						<input type="radio" name="purchase_free_shipping" value="0" class="ace" {if $row->purchase_free_shipping==0}checked{/if} />
						<span class="lbl">否</span>
					</label>
				</div>
				<div class="radio">
					<label>
						<input type="radio" name="purchase_free_shipping" value="1" class="ace" {if $row->purchase_free_shipping==1}checked{/if} />
						<span class="lbl">是</span>
					</label>
				</div>
			</div>
		</div>
		{/if}
		{if in_array('chop', $function)}
		<div class="ge-group"></div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_price">砍价最低价</label>
			<div class="col-sm-10">
				<input type="text" name="chop_price" id="chop_price" value="{if $row->chop_price>0}{$row->chop_price}{/if}" class="col-xs-2" />
				<span class="some-block">元</span>
				<span class="some-line">留空即不参与砍价活动</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_begin_time">砍价时间</label>
			<div class="col-sm-10">
				<input type="text" id="chop_begin_time" name="chop_begin_time" value="{if $row->chop_begin_time>0}{date('Y-m-d H:i', $row->chop_begin_time)}{/if}" class="col-xs-2 coo-^#chop_end_time" @="#chop_end_time" />
				<span class="some-item">-</span>
				<input type="text" id="chop_end_time" name="chop_end_time" value="{if $row->chop_end_time>0}{date('Y-m-d H:i', $row->chop_end_time)}{/if}" class="col-xs-2" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_num">至少砍刀数</label>
			<div class="col-sm-10">
				<input type="text" name="chop_num" id="chop_num" value="{if $row->chop_num>0}{$row->chop_num}{/if}" class="col-xs-2" />
				<span class="some-line">不包含自己砍的第一刀</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_amount">砍价数量</label>
			<div class="col-sm-10">
				<input type="text" name="chop_amount" id="chop_amount" value="{if $row->chop_amount>0}{$row->chop_amount}{/if}" class="col-xs-2 coo-!<=#stocks" />
				<span class="some-line">留空即为最大库存数，不可大于库存数</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_time">砍价限时</label>
			<div class="col-sm-10">
				<input type="text" name="chop_time" id="chop_time" value="{if $row->chop_time>0}{$row->chop_time}{/if}" class="col-xs-2" />
				<span class="some-block">小时内</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="chop_free_shipping">砍价时包邮</label>
			<div class="col-sm-10">
				<div class="radio">
					<label>
						<input type="radio" name="chop_free_shipping" value="0" class="ace" {if $row->chop_free_shipping==0}checked{/if} />
						<span class="lbl">否</span>
					</label>
				</div>
				<div class="radio">
					<label>
						<input type="radio" name="chop_free_shipping" value="1" class="ace" {if $row->chop_free_shipping==1}checked{/if} />
						<span class="lbl">是</span>
					</label>
				</div>
			</div>
		</div>
		{/if}
		{if in_array('grade', $function)}
		<div class="ge-group"></div>
		<div class="form-group grade-container">
			<textarea id="gradeprices" class="hidden">{if is_array($grade)}{json_encode($grade)}{/if}</textarea>
			<label class="col-sm-2 control-label no-padding-right" for="grade_price">等级会员价</label>
			<div class="col-sm-10">
				{if is_array($grade)}
				<div class="mul-group grade-group">
					<div class="mul-group-row grade-row">{if is_array($gradeprices)}
						{foreach from=$gradeprices item=g}
						<div class="mul-list grade-list">
							<div class="form-group">
								<div class="col-sm-12">
									<div class="col-xs-2">
										<select name="grade_id[]" class="some-width100p">
										<option value="">选择等级</option>
										{foreach from=$grade item=gr}
										<option value="{$gr->id}" {if $g->grade_id==$gr->id}selected{/if}>{$gr->name}</option>
										{/foreach}
										</select>
									</div>
									<div class="col-sm-2">
										<input type="tel" name="grade_price[]" value="{$g->price}" placeholder="价格" class="some-width100p" />
									</div>
									<a href="javascript:void(0)" class="del">×</a>
								</div>
							</div>
						</div>
						{/foreach}
					{/if}</div>
					<div class="mul-toolbar grade-toolbar">
						<button type="button" class="btn btn-info btn-sm">
							<i class="ace-icon fa fa-plus"></i>添加会员价
						</button>
					</div>
				</div>
				{else}
				<h5>请先添加<a href="?app=grade&act=add" target="_blank" class="iframe-layer">会员等级</a>，添加后<a href="javascript:void(0)">刷新</a></h5>
				{/if}
			</div>
		</div>
		{/if}
		</div>
		{/if}
		{if $edition>1}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="stocks">库存</label>
			<div class="col-sm-10">
				<input type="text" id="stocks" name="stocks" value="{$row->stocks}" class="col-xs-2 coo->0" />
				<span class="some-inline">库存为 0 时，会移到『下架』的商品列表里，保存后买家看到的商品可售库存会同步更新</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="stock_alert_number">库存报警数量</label>
			<div class="col-sm-10">
				<input type="text" id="stock_alert_number" name="stock_alert_number" value="{$row->stock_alert_number}" class="col-xs-2" />
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="market_price">市场价格</label>
			<div class="col-sm-10">
				<input type="text" id="market_price" name="market_price" value="{$row->market_price}" class="col-xs-2" />
				<span class="some-block">元</span>
				<span class="some-line">(划线价)</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="cost_price">成本价</label>
			<div class="col-sm-10">
				<input type="text" id="cost_price" name="cost_price" value="{$row->cost_price}" class="col-xs-2" />
				<span class="some-block">元</span>
				<span class="some-inline">成本价未来会用于营销建议，利润分析等</span>
			</div>
		</div>
		{if $edition>1}
		<div class="form-group params-container">
			<label class="col-sm-2 control-label no-padding-right" for="params">参数</label>
			<div class="col-sm-10">
				<div class="mul-group params-group">
					<div class="mul-group-row params-row">{if is_array($row->params)}
						{foreach from=$row->params item=g}
						<div class="mul-list params-list">
							<div class="form-group">
								<div class="col-sm-12">
									<div class="col-sm-2">
										<input type="text" name="params_name[]" value="{$g.name}" placeholder="名称" class="some-width100p" />
									</div>
									<div class="some-line">：</div>
									<div class="col-sm-2">
										<input type="text" name="params_value[]" value="{$g.value}" placeholder="数值" class="some-width100p" />
									</div>
									<a href="javascript:void(0)" class="del">×</a>
								</div>
							</div>
						</div>
						{/foreach}
					{/if}</div>
					<div class="mul-toolbar params-toolbar">
						<button type="button" class="btn btn-info btn-sm">
							<i class="ace-icon fa fa-plus"></i>添加参数
						</button>
					</div>
				</div>
			</div>
		</div>
		{/if}
		{if in_array('commission',$function)}
		<div class="form-group commission-container">
			<label class="col-sm-2 control-label no-padding-right" for="commission">佣金分利</label>
			<div class="col-sm-10">
				<div class="form-group">
					<div class="col-sm-10">
						<div class="radio">
							<label>
								<input type="radio" name="commission_type" value="0" class="ace" {if $row->commission_type==0}checked{/if} />
								<span class="lbl">关闭</span>
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="commission_type" value="1" class="ace" {if $row->commission_type==1}checked{/if} />
								<span class="lbl">百分比(%)</span>
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="commission_type" value="2" class="ace" {if $row->commission_type==2}checked{/if} />
								<span class="lbl">固定金额(￥)</span>
							</label>
						</div>
					</div>
				</div>
				<div class="mul-group commission-group">
					<div class="mul-group-row commission-row">{if is_array($row->commissions)}
						{foreach from=$row->commissions item=g key=i}
						<div class="mul-list commission-list">
							<div class="form-group">
								<label class="col-sm-1 control-label no-padding-right">{$i+1}级分利</label>
								<div class="col-sm-11">
									<div class="col-xs-2">
										<input type="text" name="commissions[]" value="{$g}" class="some-width100p coo-!>0" />
									</div>
									<a href="javascript:void(0)" class="del">×</a>
								</div>
							</div>
						</div>
						{/foreach}
					{/if}</div>
					<div class="mul-toolbar commission-toolbar">
						<button type="button" class="btn btn-info btn-sm" {if is_array($row->commissions) && count($row->commissions)>=3}disabled{/if}>
							<i class="ace-icon fa fa-plus"></i>添加分利
						</button>
					</div>
				</div>
				<span class="some-line">只可填数字(包括小数)，一般情况下级数越高分利越低</span>
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="description">简要描述</label>
			<div class="col-sm-10">
				<input type="text" id="description" name="description" value="{$row->description}" class="col-xs-6" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="keywords">关键词</label>
			<div class="col-sm-10">
				<input type="text" id="keywords" name="keywords" value="{$row->keywords}" class="col-xs-6" />
			</div>
		</div>
		{if $edition>1}
		<div class="form-block free-group {if $row->type>0}hidden{/if}">
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="free_shipping">是否包邮</label>
			<div class="col-sm-10">
				<div class="radio">
					<label>
						<input type="radio" name="free_shipping" value="0" class="free_shipping ace" {if $row->free_shipping==0}checked{/if} />
						<span class="lbl">否</span>
					</label>
				</div>
				<div class="radio">
					<label>
						<input type="radio" name="free_shipping" value="1" class="free_shipping ace" {if $row->free_shipping==1}checked{/if} />
						<span class="lbl">是</span>
					</label>
				</div>
			</div>
		</div>
		<div class="form-group fee-group {if $row->free_shipping==1}hidden{/if}">
			<label class="col-sm-2 control-label no-padding-right" for="shipping">快递运费</label>
			<div class="col-sm-10">
				<div class="col-sm-10">
					<div class="radio">
						<label>
							<input type="radio" name="shipping" class="shipping ace" value="0" {if $row->shipping_fee>0 || ($row->shipping_fee==0 && $row->shipping_fee_id==0)}checked{/if} />
							<span class="lbl">统一运费</span>
						</label>
					</div>
					<input type="tel" id="shipping_fee" name="shipping_fee" value="{$row->shipping_fee}" class="col-xs-6 some-width60" />
					<span class="some-block">元</span>
				</div>
				<div class="col-sm-10">
					<div class="radio">
						<label>
							<input type="radio" name="shipping" class="shipping ace" value="1" {if $row->shipping_fee_id>0}checked{/if} />
							<span class="lbl">运费模板</span>
						</label>
					</div>
					<select class="selectpicker" id="shipping_fee_id" name="shipping_fee_id" search="true" {if !count($shipping)}disabled{/if}>
						{if count($shipping)}
						<option value=""></option>
						{foreach from=$shipping item=g}
						<option value="{$g->id}" type="{$g->type}" {if $row->shipping_fee_id==$g->id}selected{/if}>{if $g->type==0}按重：{else}按件：{/if}{$g->name}</option>
						{/foreach}
						{else}
						<option value="">暂无运费模板</option>
						{/if}
					</select>
					<span class="some-item">
						<a href="javascript:void(0)" class="get_shipping">刷新</a> | <a href="?app=setting&act=shipping_edit" target="_blank" class="iframe-layer">新建</a> | <a href="?app=setting&act=shipping" target="_blank" class="iframe-layer">模板管理</a>
					</span>
				</div>
				<div class="col-sm-10 weight-group hidden">
					<span class="some-block-inline">商品重量</span>
					<input type="tel" id="weight" name="weight" value="{$row->weight}" class="col-xs-6 some-width60" />
					<span class="some-block">KG</span>
				</div>
			</div>
		</div>
		{if $edition>2}
		<div class="form-group fee-group {if $row->free_shipping==1}hidden{/if}">
			<label class="col-sm-2 control-label no-padding-right" for="free_shipping_count">运费促销</label>
			<div class="col-sm-10">
				<span class="some-block-inline">购买</span>
				<input type="tel" id="free_shipping_count" name="free_shipping_count" value="{if $row->free_shipping_count>0}{$row->free_shipping_count}{/if}" class="col-xs-6 some-width40" />
				<span class="some-block-inline">件起包邮</span>
				<span class="some-line">为空即不进行运费促销</span>
			</div>
		</div>
		{/if}
		</div>
		{/if}
		{if in_array('integral',$function)}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="integral">积分购买</label>
			<div class="col-sm-10">
				<input type="text" name="integral" id="integral" value="{$row->integral}" class="col-xs-2 some-width180" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="give_integral">购买后赠送积分</label>
			<div class="col-sm-10">
				<input type="text" name="give_integral" id="give_integral" value="{$row->give_integral}" class="col-xs-2 some-width180" />
			</div>
		</div>
		{/if}
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="ext_property">扩展属性</label>
			<div class="col-sm-10">
				<div class="checkbox">
					<label>
						<input type="checkbox" name="ext_property[]" value="1" class="ace" {if strpos(','|cat:$row->ext_property|cat:',', ',1,')!==false}checked{/if} />
						<span class="lbl">推荐</span></label>
				</div>
				<div class="checkbox" >
					<label>
						<input type="checkbox" name="ext_property[]" value="2" class="ace" {if strpos(','|cat:$row->ext_property|cat:',', ',2,')!==false}checked{/if} />
						<span class="lbl">热销</span></label>
				</div>
				<div class="checkbox">
					<label>
						<input type="checkbox" name="ext_property[]" value="3" class="ace" {if strpos(','|cat:$row->ext_property|cat:',', ',3,')!==false}checked{/if} />
						<span class="lbl">精品</span></label>
				</div>
				<div class="checkbox">
					<label>
						<input type="checkbox" name="ext_property[]" value="4" class="ace" {if strpos(','|cat:$row->ext_property|cat:',', ',4,')!==false}checked{/if} />
						<span class="lbl">新品</span></label>
				</div>
				<div class="checkbox">
					<label>
						<input type="checkbox" name="ext_property[]" value="5" class="ace" {if strpos(','|cat:$row->ext_property|cat:',', ',5,')!==false}checked{/if} />
						<span class="lbl">折扣</span></label>
				</div>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="sort">排序</label>
			<div class="col-sm-10">
				<input type="text" name="sort" id="sort" value="{$row->sort}" class="col-xs-2 some-width180" />
				<span class="some-line">数字越小，排在越前</span>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="status">上架形式</label>
			<div class="col-sm-10">
				<div class="col-sm-10">
					<div class="radio">
						<label>
							<input type="radio" name="status" value="1" class="status ace" {if $row->status==1}checked{/if} />
							<span class="lbl">立即上架售卖</span></label>
					</div>
				</div>
				{if $edition>2}
				<div class="col-sm-10">
					<div class="radio">
						<label>
							<input type="radio" name="status" value="-1" class="status ace" {if $row->status==-1}checked{/if} />
							<span class="lbl">自定义上架时间</span></label>
					</div>
					<input type="text" id="release_time" name="release_time" value="{if $row->release_time>0}{date('Y-m-d H:i', $row->release_time)}{/if}" class="col-xs-2" />
				</div>
				{/if}
				<div class="col-sm-10">
					<div class="radio">
						<label>
							<input type="radio" name="status" value="0" class="status ace" {if $row->status==0}checked{/if} />
							<span class="lbl">暂不售卖，放入仓库 (下架)</span></label>
					</div>
				</div>
			</div>
		</div>
		<!--
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="in_shop">线下门店是否有销售</label>
			<div class="col-sm-10">
				<div class="radio">
					<label>
						<input type="radio" name="in_shop" value="1" class="ace" {if $row->in_shop == 1 }checked{/if}/>
						<span class="lbl">是</span></label>
				</div>
				<div class="radio">
					<label>
						<input type="radio" name="in_shop" value="0" class="ace" {if $row->in_shop == 0 }checked{/if}/>
						<span class="lbl">否</span></label>
				</div>
			</div>
		</div>
		-->
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="note">商家备注</label>
			<div class="col-sm-10">
				<input type="text" name="note" id="note" value="{$row->seller_note}" class="col-xs-10" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label no-padding-right" for="content">
				商品详情
				<div class="clear"></div>
				<div class="checkbox not-mobile" >
					<label><input type="checkbox" class="premobile ace" /> <span class="lbl">预览</span></label>
				</div>
			</label>
			<div class="col-sm-10">
				<textarea class="ckeditor" name="content" id="content" rows="20">{$row->content}</textarea>
			</div>
		</div>
		
		<div class="clearfix form-actions">
			<div class="col-md-offset-3 col-md-9">
				<button class="btn btn-info" type="submit">
					<i class="ace-icon fa fa-check bigger-110"></i>
					提交
				</button>

				&nbsp; &nbsp; &nbsp;
				<button class="btn" type="reset">
					<i class="ace-icon fa fa-undo bigger-110"></i>
					重置
				</button>
			</div>
		</div>
	</form>
</div>
</div>
{include file="footer.html"}
<script>
function deletePic(k){
	if(!confirm('是否删除？'))return;
	$(k).parent().remove();
	if($('#imgs').children().length<Number('{$configs.GLOBAL_GOODS_IMAGE_NUM}'))$('#file').show();
}
function setDragsort(){
	$('#imgs').dragsort({
		dragList : 'div',
		dragItem : 'span',
		//lockRange : true,
		placeHolder : '<div class="hold"></div>',
		start : function(){
			$('.hold').html(this.html()).attr('style', this.attr('data-style')).css({
				width:this.outerWidth(false),
				height:this.outerHeight(false),
				opacity:0.3
			});
		},
		after : function(){
			if($.browser.mobile)$('#imgs a[href!="javascript:void(0)"]').photoBrowser();
		}
	});
	if($.browser.mobile)$('#imgs a[href!="javascript:void(0)"]').photoBrowser();
	$('#imgs a[href!="javascript:void(0)"]').loadbackground();
}
function deleteSelf(k){
	$(k).parent().parent().remove();
}
function changeFreeShipping(){
	if($(this).val()=='1'){
		$('.fee-group').addClass('hidden');
		$('#weight').removeClass('coo->0');
	}else{
		$('.fee-group').removeClass('hidden');
		changeShipping.call($('input.shipping:checked'));
	}
}
function changeShipping(){
	if($(this).val()=='0'){
		$('.weight-group').addClass('hidden');
		$('#weight').removeClass('coo->0');
	}else{
		selected.call($('#shipping_fee_id'));
	}
}
function selected(){
	$('.shipping').checked('1');
	if(!!this.selected().attr('type')){
		if(Number(this.selected().attr('type'))==1){
			$('.weight-group').addClass('hidden');
			$('#weight').removeClass('coo->0');
		}else{
			$('.weight-group').removeClass('hidden');
			$('#weight').addClass('coo->0');
		}
	}
}
$(function(){
	setDragsort();
	$('.selectpicker').selectpicker({ isPicker:false });
	$('#promote_begin_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#promote_end_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#groupbuy_begin_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#groupbuy_end_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#purchase_begin_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#purchase_end_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#chop_begin_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#chop_end_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn', readonly:false });
	$('#release_time').datepicker({ showTime:true, showSecond:false, format:'yyyy-m-d hh:nn' });
	$('.status').change(function(){
		if($(this).val()=='-1'){
			$('#release_time').addClass('coo-need').click();
		}else{
			$('#release_time').removeClass('coo-need');
		}
	});
	changeFreeShipping.call($('input.free_shipping:checked'));
	$('input.free_shipping').click(function(){
		changeFreeShipping.call(this);
	});
	$('input.shipping').click(function(){
		changeShipping.call(this);
	});
	$('#shipping_fee_id').selectpicker({ select:selected });
	$('.get_shipping').click(function(){
		var value = $('#shipping_fee_id').selected().val();
		$.getJSON('{$GM_PATH}api/goods/get_shipping', function(json){
			if($.isArray(json.data)){
				var html = '<option value=""></option>';
				$.each(json.data, function(){
					html += '<option value="'+this.id+'" type="'+this.type+'" '+(value==this.id?'selected':'')+'>'+(this.type==0?'按重：':'按件：')+this.name+'</option>';
				});
				$('#shipping_fee_id').removeAttr('disabled').html(html).selectpicker({ select:selected });
			}else{
				var html = '<option value="">暂无运费模板</option>';
				$('#shipping_fee_id').attr('disabled', 'disabled').html(html).selectpicker({ select:selected });
			}
		});
	});
	$('.goods-type-box input').click(function(){
		var val = Number($(this).val());
		switch(val){
			case 0:
			//case 4:
				$('.free-group').removeClass('hidden');
				break;
			default:
				$('.free-group').addClass('hidden');
				$('#weight').removeClass('coo->0');
				$('.free_shipping:eq(1)').click();
				break;
		}
	});
	//添加图片
	$('#files').html5upload({
		url : '{$GM_PATH}api/goods/upload_pic',
		name : 'pic',
		before : function(){
			if($('#imgs').children().length>=Number('{$configs.GLOBAL_GOODS_IMAGE_NUM}')){
				alert('图片不可超过{$configs.GLOBAL_GOODS_IMAGE_NUM}张');
				return false;
			}
			$.overload();
		},
		success : function(json){
			$.overload(false);
			var html = '<div>\
				<span title="拖动改变顺序">≡</span>\
				<a href="'+json.data+'" target="_blank"></a>\
				<input type="hidden" name="pics[]" value="'+json.data+'" />\
				<input type="text" name="memos[]" placeholder="图片说明" value="" />\
				<input type="text" name="videos[]" placeholder="视频网址" value="" />\
				<a href="javascript:void(0)" onclick="deletePic(this)"></a>\
			</div>';
			$('#imgs').append(html);
			if($('#imgs').children().length>=Number('{$configs.GLOBAL_GOODS_IMAGE_NUM}'))$('#file').hide();
			if($('#imgs').children().length==1 && !$('#origin_pic').val().length){
				$('#origin_pic').val(json.data).before('<a href="'+json.data+'" target="_blank"><img src="'+json.data+'" height="34" onerror="this.src=\'/images/nopic.png\'" /></a>');
			}
			setDragsort();
		}
	});
	
	//规格
	var specData = {$specData};
	$('.spec-toolbar button').click(function(){
		if($('.spec-group .spec-list').length>=Number('{$configs.GLOBAL_GOODS_SPEC_NUM}'))return;
		var html = '<div class="mul-list spec-list">\
			<div class="form-group">\
				<label class="col-sm-1 control-label no-padding-right">规格名</label>\
				<div class="col-sm-11">\
					<div class="col-xs-2">\
						<input type="text" value="" class="spec-field spec-name some-width100p" spec_id="0" parent_id="0" />\
						<input type="hidden" name="spec_id[]" />\
					</div>\
					<a href="javascript:void(0)" class="del" parent="spec-list">×</a>\
				</div>\
			</div>\
			<div class="form-group">\
				<label class="col-sm-1 control-label no-padding-right">规格值</label>\
				<div class="col-sm-11"></div>\
			</div>\
		</div>';
		html = $(html);
		$('.spec-row').append(html);
		var specName = html.find('.spec-field');
		setShowmenu.call(specName);
		setTimeout(function(){ specName.focus().click() }, 0);
		if($('.spec-group .spec-list').length>=Number('{$configs.GLOBAL_GOODS_SPEC_NUM}'))$(this).prop('disabled', true);
	});
	$('.spec-group').on('focus', '.spec-field', function(){
		$(this).data('value', $(this).val());
	});
	$('.spec-group').on('blur', '.spec-field', function(){
		var _this = $(this), parent_id = Number(_this.attr('parent_id')), sub = parent_id==0?_this.parents('.form-group').eq(0).next().find('.col-sm-11'):null;
		if(!_this.val().length){
			if(parent_id==0){
				specData = { };
				sub.html('');
			}
			else setSpecDetail();
			return;
		}
		if(!!_this.data('value') && _this.data('value')==_this.val())return;
		$.postJSON('{$GM_PATH}api/goods/set_spec_category', { parent_id:parent_id, name:_this.val() }, function(json){
			if(json.error!=0){
				if(parent_id==0){
					specData = { };
					sub.html('');
				}
				else setSpecDetail();
				return;
			};
			var id = json.data;
			_this.attr('spec_id', id).next().val(id);
			if(parent_id==0){
				var html = '<a href="javascript:void(0)" class="add" parent_id="'+id+'">添加规格值</a>';
				sub.html(html);
				sub.find('.add').click();
			}else{
				setSpecDetail();
			}
		});
	});
	function setSpecDetail(){
		var specName = $('.spec-name'), hiddenDetail = true;
		specName.each(function(){
			var val = $(this).val();
			if(!val.length)return true;
			var specSubname = $(this).parents('.form-group').eq(0).next().find('.col-sm-11').find('.spec-subname'), hasVal = false;
			specSubname.each(function(){
				if(!$(this).val().length)return true;
				hasVal = true;
				return false;
			});
			if(!hasVal)return true;
			hiddenDetail = false;
			return false;
		});
		if(hiddenDetail){
			specData = { };
			$('.spec-table').html('');
			$('.spec-detail').addClass('hidden');
			$('#price').prop('readonly', false);
			$('#stocks').prop('readonly', false);
			$('#promote_price').prop('readonly', false);
			$('#groupbuy_price').prop('readonly', false);
			$('#purchase_price').prop('readonly', false);
			$('#chop_price').prop('readonly', false);
			return;
		};
		var specs = specRecursive();
		var html = '<table>\
			<thead>\
				<tr>';
					specName.each(function(){
						var val = $(this).val();
						if(!val.length)return true;
						var specSubname = $(this).parents('.form-group').eq(0).next().find('.col-sm-11').find('.spec-subname'), hasVal = false;
						specSubname.each(function(){
							if(!$(this).val().length)return true;
							hasVal = true;
							return false;
						});
						if(!hasVal)return true;
						html += '<th>'+val+'</th>';
					});
					html += '<th>价格(元)</th>\
					<th>库存(件)</th>\
					{if $edition>2}<th>促销价(元)</th>{/if}\
					{if in_array('groupbuy', $function)}<th>拼团价(元)</th>{/if}\
					{if in_array('purchase', $function)}<th>秒杀价(元)</th>{/if}\
					{if in_array('chop', $function)}<th>砍价最低价(元)</th>{/if}\
					<th>图片(建议800x800)</th>';
				html += '</tr>\
			</thead>\
			<tbody>';
				$.each(specs, function(){
					html += '<tr>';
						var ids = [];
						$.each(this, function(){
							ids.push(this.id);
							html += '<td rowspan="1">'+this.name+'</td>';
						});
						html += '<td>\
							<input type="hidden" name="spec_tree[]" value="'+ids.join(',')+'" />\
							<input type="text" name="spec_price[]" value="'+(specData['spec_price_'+ids.join('_')]?specData['spec_price_'+ids.join('_')].numberFormat(2):'')+'" combo_id="spec_price_'+ids.join('_')+'" class="some-width100 spec_price coo-float->0" /></td>\
						<td><input type="text" name="spec_stock[]" value="'+(specData['spec_stock_'+ids.join('_')]?specData['spec_stock_'+ids.join('_')]:'')+'" combo_id="spec_stock_'+ids.join('_')+'" class="some-width100 spec_stock coo-num->0" /></td>\
						{if $edition>2}<td><input type="text" name="spec_promote[]" value="'+(specData['spec_promote_'+ids.join('_')]?specData['spec_promote_'+ids.join('_')].numberFormat(2):'')+'" combo_id="spec_promote_'+ids.join('_')+'" class="some-width100 spec_promote coo-!>=0" /></td>{/if}\
						{if in_array("groupbuy", $function)}<td><input type="text" name="spec_groupbuy[]" value="'+(specData['spec_groupbuy_'+ids.join('_')]?specData['spec_groupbuy_'+ids.join('_')].numberFormat(2):'')+'"  combo_id="spec_groupbuy_'+ids.join('_')+'" class="some-width100 spec_groupbuy coo-!>=0" /></td>{/if}\
						{if in_array("purchase", $function)}<td><input type="text" name="spec_purchase[]" value="'+(specData['spec_purchase_'+ids.join('_')]?specData['spec_purchase_'+ids.join('_')].numberFormat(2):'')+'"  combo_id="spec_purchase_'+ids.join('_')+'" class="some-width100 spec_purchase coo-!>=0" /></td>{/if}\
						{if in_array("chop", $function)}<td><input type="text" name="spec_chop[]" value="'+(specData['spec_chop_'+ids.join('_')]?specData['spec_chop_'+ids.join('_')].numberFormat(2):'')+'"  combo_id="spec_chop_'+ids.join('_')+'" class="some-width100 spec_chop coo-!>=0" /></td>{/if}\
						<td><a href="javascript:void(0)" class="spec_pic" '+(specData['spec_pic_'+ids.join('_')]?'style="background-image:url('+specData['spec_pic_'+ids.join('_')]+');"':'')+'><i>+</i></a><input type="hidden" name="spec_pic[]" value="'+(specData['spec_pic_'+ids.join('_')]?specData['spec_pic_'+ids.join('_')]:'')+'" combo_id="spec_pic_'+ids.join('_')+'" /><a href="javascript:void(0)" class="copy">复制</a><a href="javascript:void(0)" class="paste">粘贴</a></td>';
					html += '</tr>';
				});
			html += '</tbody>\
			<tfoot>\
				<tr>\
					<td colspan="'+(specName.length+4)+'">\
						<div>批量设置</div>\
						<div class="spec-origin">\
							<a href="javascript:void(0)" class="spec-price">价格</a>\
							<a href="javascript:void(0)" class="spec-stock">库存</a>\
							{if $edition>2}<a href="javascript:void(0)" class="spec-promote">促销价</a>{/if}\
							{if in_array("groupbuy", $function)}<a href="javascript:void(0)" class="spec-groupbuy">拼团价</a>{/if}\
							{if in_array("purchase", $function)}<a href="javascript:void(0)" class="spec-purchase">秒杀价</a>{/if}\
							{if in_array("chop", $function)}<a href="javascript:void(0)" class="spec-chop">砍价最低价</a>{/if}\
						</div>\
						<div class="spec-set hidden">\
							<input type="tel" class="spec-number some-width100" />\
							<a href="javascript:void(0)" class="spec-ok">保存</a>\
							<a href="javascript:void(0)" class="spec-cancel">取消</a>\
						</div>\
					</td>\
				</tr>\
			</tfoot>\
		</table>';
		$('.spec-table').html(html);
		var td = $('.spec-table tbody tr:eq(0) td:not(:has(input))');
		td.sort(function(a, b){
			var sort1 = $(a).index(), sort2 = $(b).index();
			if(sort1<sort2)return 1;
			if(sort1>sort2)return -1;
			return 0;
		});
		td.each(function(){
			setRowspan($(this).index());
		});
		$('.spec-detail').removeClass('hidden');
		$('#price').prop('readonly', true);
		$('#stocks').prop('readonly', true);
		$('#promote_price').prop('readonly', true);
		$('#groupbuy_price').prop('readonly', true);
		$('#purchase_price').prop('readonly', true);
		$('#chop_price').prop('readonly', true);
	}
	function setRowspan(index){
		var html = '', lastTd = null, count = 1;
		$('.spec-table tbody tr').each(function(i){
			var td = $(this).find('td').eq(index), flag = true, h = td.html();
			if(!lastTd)lastTd = td;
			if(td.prev().length && $('.spec-table tbody tr').eq(i-1).length){
				var prevTrPrevTd = $('.spec-table tbody tr').eq(i-1).find('td').eq(index-1);
				flag = td.prev().html()==prevTrPrevTd.html();
			}
			if(h==html && flag){
				count++;
				td.remove();
			}else if(html.length){
				lastTd.attr('rowspan', count);
				lastTd = td;
				count = 1;
			}
			if(h==html && i==$('.spec-table tbody tr').length-1){
				lastTd.attr('rowspan', count);
			};
			html = h;
		});
	}
	function specInterlock(arr, index){
		for(var i=0; i<arr[index].length; i++){
			result[index] = arr[index][i];
			if(index < arr.length-1){
				specInterlock(arr, index+1);
			}else{
				var r = $.jsonString(result);
				r = $.json(r);
				results.push(r);
			}
		}
	}
	function getInterlock(arr){
		results = [];
		result = [];
		specInterlock(arr, 0);
		return results;
	}
	function specRecursive(){
		var arr = [];
		$('.spec-list').each(function(){
			var specSubname = $(this).find('.spec-subname'), obj = [];
			specSubname.each(function(){
				var _this = $(this);
				if(!_this.val().length)return true;
				obj.push({ id:_this.attr('spec_id'), name:_this.val() });
			});
			if(obj.length)arr.push(obj);
		});
		return getInterlock(arr);
	}
	function setShowmenu(){
		var specName = this;
		specName.showmenu({
			cls : 'showmenu',
			html : '',
			arrow : false,
			on : function(list){
				$.getJSON('{$GM_PATH}api/goods/get_spec_category', { parent_id:specName.attr('parent_id') }, function(json){
					var html = '<ul>';
					if($.isArray(json.data)){
						$.each(json.data, function(){
							html += '<li><a href="javascript:void(0)" spec_id="'+this.id+'">'+this.name+'</a></li>';
						});
					}else{
						html += '<li><span>当前没有匹配项</span></li>';
					};
					html += '</ul>';
					html = $(html);
					html.find('a').click(function(){
						specName.val($(this).text()).attr('spec_id', $(this).attr('spec_id'));
						specName.showmenu(false);
						specName.blur();
					});
					list.html(html).find('a').removeClass('this').each(function(){
						if(specName.val()==$(this).text())$(this).addClass('this');
					});
				});
			}
		});
	}
	$('.spec-group').on('click', 'a.add', function(){
		var parent_id = $(this).attr('parent_id');
		var html = $('<div class="col-xs-2">\
			<input type="text" value="" class="spec-field spec-subname some-width100p" spec_id="0" parent_id="'+parent_id+'" />\
			<input type="hidden" name="spec_subid[]" />\
			<a href="javascript:void(0)" class="del" parent="col-xs-2">×</a>\
		</div>');
		$(this).before(html);
		var specName = html.find('.spec-field');
		setShowmenu.call(specName);
		setTimeout(function(){ specName.focus().click() }, 0);
	});
	$('.spec-group').on('click', 'a.del', function(){
		$(this).parents('.'+$(this).attr('parent')).eq(0).remove();
		if($('.spec-group .spec-list').length<3)$('.spec-toolbar button').prop('disabled', false);
		setSpecDetail();
	});
	$('.spec-table').on('blur', '.spec_price, .spec_promote', function(){
		$(this).val($(this).val().numberFormat(2));
	});
	$('.spec-table').on('click', 'tfoot .spec-origin a', function(){
		if($(this).is('.spec-price')){
			$('.spec-number').attr('placeholder', '价格').attr('spec-type', 'price');
		}else if($(this).is('.spec-stock')){
			$('.spec-number').attr('placeholder', '库存').attr('spec-type', 'stock');
		}else if($(this).is('.spec-promote')){
			$('.spec-number').attr('placeholder', '促销价').attr('spec-type', 'promote');
		}else if($(this).is('.spec-groupbuy')){
			$('.spec-number').attr('placeholder', '拼团价').attr('spec-type', 'groupbuy');
		}else if($(this).is('.spec-purchase')){
			$('.spec-number').attr('placeholder', '秒杀价').attr('spec-type', 'purchase');
		}else if($(this).is('.spec-chop')){
			$('.spec-number').attr('placeholder', '砍价最低价').attr('spec-type', 'chop');
		};
		$('.spec-origin').addClass('hidden');
		$('.spec-set').removeClass('hidden');
	});
	$('.spec-table').on('click', 'tfoot .spec-set a', function(){
		if($(this).is('.spec-ok')){
			var type = $('.spec-number').attr('spec-type'), val = $('.spec-number').val();
			if(type!='stock')val = val.numberFormat(2);
			var length = $('.spec_'+type).val(val).length;
			switch(type){
				case 'price':$('#price').val(val.numberFormat(2));break;
				case 'stock':$('#stocks').val(val*length);break;
				case 'promote':$('#promote_price').val(val.numberFormat(2));break;
				case 'groupbuy':$('#groupbuy_price').val(val.numberFormat(2));break;
				case 'purchase':$('#purchase_price').val(val.numberFormat(2));break;
				case 'chop':$('#chop_price').val(val.numberFormat(2));break;
			}
		};
		$('.spec-origin').removeClass('hidden');
		$('.spec-set').addClass('hidden');
		$('.spec-number').val('');
	});
	$('.spec-table').on('input', 'input.spec_price', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_price').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			if(val<=0 || val>Number($(this).val()))val = Number($(this).val());
		});
		$('#price').val(val.numberFormat(2));
	});
	$('.spec-table').on('input', 'input.spec_stock', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_stock').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			val += Number($(this).val());
		});
		$('#stocks').val(val);
	});
	$('.spec-table').on('input', 'input.spec_promote', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_promote').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			if(val<=0 || val>Number($(this).val()))val = Number($(this).val());
		});
		$('#promote_price').val(val.numberFormat(2));
	});
	$('.spec-table').on('input', 'input.spec_groupbuy', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_groupbuy').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			if(val<=0 || val>Number($(this).val()))val = Number($(this).val());
		});
		$('#groupbuy_price').val(val.numberFormat(2));
	});
	$('.spec-table').on('input', 'input.spec_purchase', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_purchase').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			if(val<=0 || val>Number($(this).val()))val = Number($(this).val());
		});
		$('#purchase_price').val(val.numberFormat(2));
	});
	$('.spec-table').on('input', 'input.spec_chop', function(){
		specData[$(this).attr('combo_id')] = $(this).val();
		var val = 0;
		$('.spec-table input.spec_chop').each(function(){
			if(!$(this).val().length || Number($(this).val())<=0)return true;
			if(val<=0 || val>Number($(this).val()))val = Number($(this).val());
		});
		$('#chop_price').val(val.numberFormat(2));
	});
	/*
	$('.spec-table').on('click', 'input.spec_purchase', function(){
		if(this.checked){
			specData[$(this).attr('combo_id')] = 1;
			$(this).prev().val(1);
		}else{
			specData[$(this).attr('combo_id')] = '';
			$(this).prev().val('');
		}
		var stocks = $('#stocks').val().length ? Number($('#stocks').val()) : 0;
		$('.spec-table input.spec_purchase:checked').each(function(){
			var s = $(this).parents('tr').find('input.spec_stock').val();
			if(!s.length)return true;
			if(Number(s)<stocks || stocks<=0) stocks = Number(s);
		});
		$('#purchase_amount').val(stocks).addClass('coo-<='+stocks);
	});
	*/
	$('.spec-table').on('click', 'a.spec_pic', function(){
		var _this = $(this);
		_this.ajaxupload({
			url : '{$GM_PATH}api/goods/upload_pic',
			name : 'pic',
			rightnow : true,
			before : function(){
				_this.find('i').addClass('preloader preloader-gray');
			},
			callback : function(json){
				_this.css('background-image', 'url('+json.data+')');
				_this.next().val(json.data);
			},
			complete : function(){
				this.find('i').removeClass('preloader').removeClass('preloader-gray');
			}
		});
	});
	$('.spec-table').on('click', 'a.copy', function(){
		var url = $(this).parent().find('input:hidden').val();
		if(!url.length){
			$.overloadError('当前没有图片');
			return;
		}
		$(document.body).data('spec_pic', url);
		$.overloadSuccess('已复制');
	});
	$('.spec-table').on('click', 'a.paste', function(){
		var url = $(document.body).data('spec_pic');
		$(this).parent().find('.spec_pic').css('background-image', 'url('+url+')').next().val(url);
	});
	$('.spec-field').each(function(){
		setShowmenu.call($(this));
	});
	if($('.spec-subname').length)setSpecDetail();
	
	//等级会员价
	$('.grade-container').on('click', '.grade-toolbar button', function(){
		var grade = $.json($('#gradeprices').val());
		var html = '<div class="mul-list grade-list">\
			<div class="form-group">\
				<div class="col-sm-12">\
					<div class="col-xs-2">\
						<select name="grade_id[]" class="some-width100p">\
						<option value="">选择等级</option>';
						$.each(grade, function(){
							html += '<option value="'+this.id+'">'+this.name+'</option>';
						});
						html += '</select>\
					</div>\
					<div class="col-sm-2">\
						<input type="tel" name="grade_price[]" value="" placeholder="价格" class="some-width100p" />\
					</div>\
					<a href="javascript:void(0)" class="del">×</a>\
				</div>\
			</div>\
		</div>';
		html = $(html);
		$('.grade-row').append(html);
	});
	$('.grade-container').on('click', 'a.del', function(){
		$(this).parents('.grade-list').eq(0).remove();
	});
	$('.grade-container').on('click', 'h5 a[href^="javascript:"]', function(){
		var _this = $(this);
		$.getJSON('{$GM_PATH}api/goods/get_grade_price', function(json){
			if(!$.isArray(json.data))return;
			$('#gradeprices').val($.jsonString(json.data));
			var html = '<div class="mul-group grade-group">\
				<div class="grade-row">\
					<div class="mul-list grade-list">\
						<div class="form-group">\
							<div class="col-sm-12">\
								<div class="col-xs-2">\
									<select name="grade_id[]" class="some-width100p">\
									<option value="">选择等级</option>';
									$.each(json.data, function(){
										html += '<option value="'+this.id+'">'+this.name+'</option>';
									});
									html += '</select>\
								</div>\
								<div class="col-sm-2">\
									<input type="tel" name="grade_price[]" value="" placeholder="价格" class="some-width100p" />\
								</div>\
								<a href="javascript:void(0)" class="del">×</a>\
							</div>\
						</div>\
					</div>\
				</div>\
				<div class="mul-toolbar grade-toolbar">\
					<button type="button" class="btn btn-info btn-sm">\
						<i class="ace-icon fa fa-plus"></i>添加会员价\
					</button>\
				</div>\
			</div>';
			_this.parent().parent().html(html);
		});
	});
	
	//参数
	$('.params-container').on('click', '.params-toolbar button', function(){
		var html = '<div class="mul-list params-list">\
			<div class="form-group">\
				<div class="col-sm-12">\
					<div class="col-sm-2">\
						<input type="text" name="params_name[]" placeholder="名称" class="some-width100p" />\
					</div>\
					<div class="some-line">：</div>\
					<div class="col-sm-2">\
						<input type="text" name="params_value[]" placeholder="数值" class="some-width100p" />\
					</div>\
					<a href="javascript:void(0)" class="del">×</a>\
				</div>\
			</div>\
		</div>';
		html = $(html);
		$('.params-row').append(html);
	});
	$('.params-container').on('click', 'a.del', function(){
		$(this).parents('.params-list').eq(0).remove();
	});
	
	//佣金分利
	$('.commission-container').on('click', '.commission-toolbar button', function(){
		if($('.commission-group .commission-list').length>=Number('{$configs.GLOBAL_GOODS_COMMISSION_NUM}'))return;
		var i = $('.commission-group .commission-list').length;
		var html = '<div class="mul-list commission-list">\
			<div class="form-group">\
				<label class="col-sm-1 control-label no-padding-right">'+(i+1)+'级分利</label>\
				<div class="col-sm-11">\
					<div class="col-xs-2">\
						<input type="text" name="commissions[]" value="" class="some-width100p coo-!>0" />\
					</div>\
					<a href="javascript:void(0)" class="del">×</a>\
				</div>\
			</div>\
		</div>';
		html = $(html);
		$('.commission-row').append(html);
		if($('.commission-group .commission-list').length>=Number('{$configs.GLOBAL_GOODS_COMMISSION_NUM}'))$(this).prop('disabled', true);
	});
	$('.commission-container').on('click', 'a.del', function(){
		$(this).parents('.commission-list').eq(0).remove();
		if($('.commission-group .commission-list').length<3)$('.commission-toolbar button').prop('disabled', false);
		$('.commission-list').each(function(i){
			$(this).find('.control-label').html((i+1)+'级分利');
		});
	});
});
</script>